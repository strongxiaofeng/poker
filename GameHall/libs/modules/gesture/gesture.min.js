var __extends=(this&&this.__extends)||(function(){var a=Object.setPrototypeOf||({__proto__:[]} instanceof Array&&function(e,c){e.__proto__=c})||function(f,c){for(var e in c){if(c.hasOwnProperty(e)){f[e]=c[e]}}};return function(f,c){a(f,c);function e(){this.constructor=f}f.prototype=c===null?Object.create(c):(e.prototype=c.prototype,new e())}})();var PropGesture=(function(){function a(f,b,i,h,e,d,c,g){if(b===void 0){b="executeGestureRecognizedCallback"}if(i===void 0){i="checkGesture"}if(h===void 0){h="updateValue"}if(e===void 0){e=null}if(d===void 0){d=false}if(c===void 0){c=0}if(g===void 0){g=1}this.n=0;this.p=true;this.pr=0;this.t=f;this.c=d;if(e){e._prev=this;this._next=e}this.p0=b;this.p1=i;this.p2=h;this.n=g}return a}());var GestureEvent=(function(a){__extends(b,a);function b(c,e,d){if(d===void 0){d=""}var f=a.call(this,c,false,null)||this;f.gm=e;f.state=d;return f}return b}(egret.Event));GestureEvent.ACHE_GESTURE="acheGesture";var GestureRecognizerPlugin=(function(){function a(b,c,f,d,e){if(b===void 0){b=""}if(c===void 0){c=0}if(f===void 0){f=false}if(d===void 0){d=false}if(e===void 0){e=1}this._failed=false;this._priority=0;this._numTouchesRequired=1;this._continuous=false;this._possible=true;this._gestureType=b;this._continuous=d;this._requireGestureRecognizerToFail=f;this._priority=c||0;this._numTouchesRequired=e}a.activate=function(c){var b=c.length;while(--b>-1){GestureManager._gesturePlugins[(new (c[b])())._gestureName]=c[b]}};a.prototype._onInitGesture=function(d,b,c){this._callBack=d;this._config=b;this._g=c;if(this._config!=null&&this._config["shouldReceiveTouch"]!=null){this._shouldReceiveTouch=this._config["shouldReceiveTouch"]}this._result=new GestureEvent(GestureEvent.ACHE_GESTURE,this._g);return true};a.prototype.executeGestureRecognizedCallback=function(){if(this._callBack.recognized){this._result.state=GestureState.RECOGNIZED;this._callBack.recognized(this._result)}};a.prototype.checkGesture=function(b){return false};a.prototype.updateValue=function(b){return true};a.prototype.gesturePossible=function(b){this._possible=b;if(this._callBack.possible){this._result.state=GestureState.POSSIBLE;this._result.possible=b;this._callBack.possible(this._result)}};a.prototype.gestureBegan=function(){if(this._callBack.began){this._result.state=GestureState.BEGAN;this._callBack.began(this._result)}};a.prototype.gestureEnded=function(){if(this._callBack.ended){this._result.state=GestureState.ENDED;this._callBack.ended(this._result)}};return a}());var PinchGestureRecognizer=(function(b){__extends(a,b);function a(c,e){if(c===void 0){c=0}if(e===void 0){e=false}var d=b.call(this,GestureType.PINCH,c,e,true,2)||this;d._cx=0;d._cy=0;d._offsetX=0;d._offsetY=0;d.pZero=new egret.Point();return d}a.prototype.checkGesture=function(e){if(e.length!=2){this._cx=0;this._offsetX=this._offsetY=0;return false}var d=e[0];var c=e[1];if(d.type==egret.TouchEvent.TOUCH_END||c.type==egret.TouchEvent.TOUCH_END){this._cx=0;this._offsetX=this._offsetY=0;return false}if(this._cx!=0){return true}this._cx=(d.stageX+c.stageX)*0.5;this._cy=(d.stageY+c.stageY)*0.5;this._d1X=d.stageX-c.stageX;this._d1Y=d.stageY-c.stageY;this._localLocation=this._g.target.globalToLocal(this._cx,this._cy,this._localLocation);if(this._callBack.changed){this._result.dx=this._offsetX;this._result.dy=this._offsetY;this._result.dScale=1;this._result.localLocation=this._localLocation;this._callBack.changed(this._result)}return true};a.prototype.updateValue=function(f){if(f.length!=2){this._cx=0;return false}var e=f[0];var c=f[1];if(e.type==egret.TouchEvent.TOUCH_END||c.type==egret.TouchEvent.TOUCH_END){this._cx=0;this._offsetX=this._offsetY=0;return false}var g=this._cx;var d=this._cy;this._cx=(e.stageX+c.stageX)*0.5;this._cy=(e.stageY+c.stageY)*0.5;this._offsetX=this._cx-g;this._offsetY=this._cy-d;this._d2X=e.stageX-c.stageX;this._d2Y=e.stageY-c.stageY;this._localLocation=this._g.target.globalToLocal(this._cx,this._cy,this._localLocation);var h=egret.Point.distance(new egret.Point(this._d2X,this._d2Y),this.pZero)/egret.Point.distance(new egret.Point(this._d1X,this._d1Y),this.pZero);this._d1X=this._d2X;this._d1Y=this._d2Y;if(this._callBack.changed){this._result.dx=this._offsetX;this._result.dy=this._offsetY;this._result.dScale=h;this._result.localLocation=this._localLocation;this._callBack.changed(this._result)}return true};return a}(GestureRecognizerPlugin));var DoubleTapGestureRecognizer=(function(a){__extends(b,a);function b(c,e){if(c===void 0){c=0}if(e===void 0){e=false}var d=a.call(this,GestureType.DOUBLE_TAP,c,e)||this;d._interval=300;d._max_dist=80;d._count=0;d._validate=false;d._sx=0;d._sy=0;d._t=new egret.Timer(d._interval,1);d._t.addEventListener(egret.TimerEvent.TIMER,d.onCheck,d);d._count=0;return d}b.prototype.checkGesture=function(d){var c=d[0];var e;if(c.type==egret.TouchEvent.TOUCH_BEGIN){if(this._count==0){this._failed=false}}if(c.type==egret.TouchEvent.TOUCH_MOVE){}if(c.type==egret.TouchEvent.TOUCH_END){if(this._count==0){this._count+=1;this._validate=true;this._t.reset();this._t.start();this._sx=c.stageX;this._sy=c.stageY}else{if(this._count==1){if(this._validate&&Math.abs(c.stageX-this._sx)<this._max_dist&&Math.abs(c.stageY-this._sy)<this._max_dist){e=true}this._count=0;this._t.stop()}}}return e};b.prototype.onCheck=function(c){this._failed=true;this._validate=false;this._count=0;if(this._requireGestureRecognizerToFail){this._g.gestureRecognizerStateChange(this._gestureType,false)}};return b}(GestureRecognizerPlugin));var GestureType=(function(){function a(){}return a}());GestureType.DOUBLE_TAP="doubleTap";GestureType.PINCH="pinch";var GestureState=(function(){function a(){}return a}());GestureState.POSSIBLE="possible";GestureState.RECOGNIZED="recognized";GestureState.FAILED="failed";GestureState.BEGAN="began";GestureState.CHANGED="changed";GestureState.ENDED="ended";GestureState.CANCELLED="cancelled";var GestureManager=(function(){function a(c,b,d){if(b===void 0){b=null}if(d===void 0){d=false}this._ref={};this._ts=[];this._touchEventPool=[];this.vars=b||{};this.target=c;c.touchEnabled=true;this._allowSimultaneous=d;this._initGesture()}a.prototype._initGesture=function(){var c,b;for(c in this.vars){if((c in a._gesturePlugins)&&(b=new a._gesturePlugins[c]())._onInitGesture(this.vars[c],this.vars[c]["config"],this)){this._firstG=new PropGesture(b,"executeGestureRecognizedCallback","checkGesture","updateValue",this._firstG,b._continuous,b._priority,b._numTouchesRequired);this._ref[b._gestureType]=this._firstG}}this.linkGestureCondition();this.target.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouched,this);this.target.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouched,this);this.target.addEventListener(egret.TouchEvent.TOUCH_END,this.onTouched,this);this.target.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,this.onTouched,this);egret.MainContext.instance.stage.addEventListener(egret.Event.LEAVE_STAGE,this.leaveStage,this)};a.prototype.leaveStage=function(c){while(this._ts.length>0){var b=this._ts.splice(0,1)[0];this._touchEventPool.push(b)}};a.prototype.linkGestureCondition=function(){var c=this._firstG;while(c){if(c.t._callBack.hasOwnProperty("requireGestureToFail")&&c.t._callBack.requireGestureToFail!=null){var b=this._ref[c.t._callBack.requireGestureToFail.type];c._f=b;b._o=c;b.t._requireGestureRecognizerToFail=true;c.t._requireGestureRecognizerToFail=true}c=c._next}};a.prototype.gestureRecognizerStateChange=function(b,c){var e=this._ref[b];var d;if(e._o!=null){if(c){e.t[e.p0]();if(e._o.h){e._o.h=false}e.r=true;if(e.c){d=this._allowSimultaneous?null:e}d=e}else{e.f=true;if(e._o.h){e._o.t[e._o.p0]();if(e._o.c){e._o.r=true}e.f=false;e._o.h=false}}}else{if(c){e.t[e.p0]();e.r=true;d=e}else{}}if(d!=null){e=this._firstG;while(e){if(e!=d){e=e._next}else{if(e!=this._firstG){e._prev._next=e._next;if(e._next!=null){e._next._prev=e._prev}this._firstG._prev=e;e._next=this._firstG;e._prev=null;this._firstG=e}break}}}};a.prototype.removeTouch=function(d){for(var b=0;b<this._ts.length;b++){if(this._ts[b].touchPointID==d.touchPointID){var c=this._ts.splice(b,1)[0];this._touchEventPool.push(c);break}}};a.prototype.cloneTouchEvent=function(c){var b=this._touchEventPool.pop();if(!b){b={}}b.stageX=c.stageX;b.stageY=c.stageY;b.type=c.type;b.touchDown=c.touchDown;b.touchPointID=c.touchPointID;return b};a.prototype.onTouched=function(g){this.removeTouch(g);this._ts.push(this.cloneTouchEvent(g));var f=this._ts;if(f.length==0){return}var c=f[0];var h=f.length;if(!c){return}if(c.type==egret.TouchEvent.TOUCH_BEGIN){this.startGlobalX=c.stageX;this.startGlobalY=c.stageY}var d=this;b();if(this.vars.onTouch!=null&&this.vars.onTouch instanceof Function){this.vars.onTouch(f)}if(g.type==egret.TouchEvent.TOUCH_END||g.type==egret.TouchEvent.TOUCH_RELEASE_OUTSIDE){this.removeTouch(g)}function b(){var j=d._firstG;if(j==null){return}if(j.r&&!j.c){j.r=false;if(!d._allowSimultaneous){return}}if(j.r&&!d._allowSimultaneous&&j.c){j.r=j.t[j.p2](f)}else{var i;while(j){if(j.t["_shouldReceiveTouch"]!=null&&!j.t["_shouldReceiveTouch"]()){j=j._next;return}var e=(j.n>=h)?j.t[j.p1](f):false;if(e){if(j._o!=null&&j._o.h){j._o.h=false}if(j._f!=null){if(j._f.r){if(!j._f.c){j._f.r=false}j=j._next}else{if(j._f.f){if(j._o!=null&&j._o.h){j._o.h=false}j._f.f=false;j.t[j.p0]();if(j._o!=null){j.r=true}if(j.c){j.r=true;j.t[j.p2](f);i=d._allowSimultaneous?null:j}j=d._allowSimultaneous?j._next:null}else{if(!j.h){j.h=true}j=j._next}}}else{if(j._o!=null&&j._o.h){j._o.h=false}j.t[j.p0]();if(j._o!=null&&j.c){j.r=true}if(j.c){j.r=true;j.t[j.p2](f);i=d._allowSimultaneous?null:j}j=d._allowSimultaneous?j._next:null}}else{if(j._o!=null){j.f=j.t._failed;if(j.f){if(j._o.h){j._o.t[j._o.p0]();if(j._o.c){j._o.t[j._o.p2](f);j._o.r=true}j.f=false;j._o.h=false;j=null}else{j=j._next}}else{j=j._next}}else{j=j._next}}}if(i!=null&&!d._allowSimultaneous){j=d._firstG;while(j){if(j!=i){j=j._next}else{if(j!=d._firstG){j._prev._next=j._next;if(j._next!=null){j._next._prev=j._prev}d._firstG._prev=j;j._next=d._firstG;j._prev=null;d._firstG=j}break}}}}}};a.add=function(e,d,f){if(d===void 0){d=null}if(f===void 0){f=false}var c=new a(e,d,f);if(a._gestures[e.hashCode]==null){a._gestures[e.hashCode]=[c]}else{var b=a._gestures[e.hashCode];b.push(c)}return c};a.removeAll=function(d){var b=a._gestures[d.hashCode];if(b&&b.length>0){for(var c=0;c<b.length;c++){b[c].dispose()}b.length=0}};a.prototype.add=function(d){var c,b;for(c in d){if((c in a._gesturePlugins)&&(b=new a._gesturePlugins[c]())._onInitGesture(d[c],d[c]["config"],this)){this._firstG=new PropGesture(b,"executeGestureRecognizedCallback","checkGesture","updateValue",this._firstG,b._continuous,b._priority,b._numTouchesRequired);this._ref[b._gestureType]=this._firstG}}};a.prototype.remove=function(c){var b;var d=this._firstG;while(d){if(d.t._gestureType==c){b=d;if(b._prev!=null){b._prev._next=b._next}if(b._next!=null){b._next._prev=b._prev}if(b==this._firstG){this._firstG=b._next}}d=d._next}return b!=null};a.prototype.dispose=function(){this.target.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouched,this);this.target.removeEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouched,this);this.target.removeEventListener(egret.TouchEvent.TOUCH_END,this.onTouched,this);egret.MainContext.instance.stage.removeEventListener(egret.Event.LEAVE_STAGE,this.leaveStage,this)};Object.defineProperty(a.prototype,"allowSimultaneous",{get:function(){return this._allowSimultaneous},set:function(b){this._allowSimultaneous=b},enumerable:true,configurable:true});return a}());GestureManager._gesturePlugins={"doubleTap":DoubleTapGestureRecognizer,"pinch":PinchGestureRecognizer};GestureManager._gestures={};