function H264bsdCanvas(e,t){this.canvasElement=e,t||this.initContextGL(),this.contextGL&&(this.initProgram(),this.initBuffers(),this.initTextures())}function XPlayer(e){this.ready=!1,this.firstFrame=!1,this.frames=[],this.lastFrameTime=0,this.renderCount=0,this.duration=0,this.currentTime=0,this.id=e}H264bsdCanvas.prototype.isWebGL=function(){return this.contextGL},H264bsdCanvas.prototype.initContextGL=function(){for(var e=this.canvasElement,t=null,r=["webgl","experimental-webgl","moz-webgl","webkit-3d"],i=0;!t&&i<r.length;){var a=r[i];try{t=e.getContext(a)}catch(e){t=null}t&&"function"==typeof t.getParameter||(t=null),++i}this.contextGL=t},H264bsdCanvas.prototype.initProgram=function(){var e=this.contextGL,t=["attribute vec4 vertexPos;","attribute vec4 texturePos;","varying vec2 textureCoord;","void main()","{","gl_Position = vertexPos;","textureCoord = texturePos.xy;","}"].join("\n"),r=["precision highp float;","varying highp vec2 textureCoord;","uniform sampler2D ySampler;","uniform sampler2D uSampler;","uniform sampler2D vSampler;","const mat4 YUV2RGB = mat4","(","1.1643828125, 0, 1.59602734375, -.87078515625,","1.1643828125, -.39176171875, -.81296875, .52959375,","1.1643828125, 2.017234375, 0, -1.081390625,","0, 0, 0, 1",");","void main(void) {","highp float y = texture2D(ySampler,  textureCoord).r;","highp float u = texture2D(uSampler,  textureCoord).r;","highp float v = texture2D(vSampler,  textureCoord).r;","gl_FragColor = vec4(y, u, v, 1) * YUV2RGB;","}"].join("\n"),i=e.createShader(e.VERTEX_SHADER);e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||console.log("Vertex shader failed to compile: "+e.getShaderInfoLog(i));var a=e.createShader(e.FRAGMENT_SHADER);e.shaderSource(a,r),e.compileShader(a),e.getShaderParameter(a,e.COMPILE_STATUS)||console.log("Fragment shader failed to compile: "+e.getShaderInfoLog(a));var s=e.createProgram();e.attachShader(s,i),e.attachShader(s,a),e.linkProgram(s),e.getProgramParameter(s,e.LINK_STATUS)||console.log("Program failed to compile: "+e.getProgramInfoLog(s)),e.useProgram(s),this.shaderProgram=s},H264bsdCanvas.prototype.initBuffers=function(){var e=this.contextGL,t=this.shaderProgram,r=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,1,-1,1,1,-1,-1,-1]),e.STATIC_DRAW);var i=e.getAttribLocation(t,"vertexPos");e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0);var a=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),e.STATIC_DRAW);var s=e.getAttribLocation(t,"texturePos");e.enableVertexAttribArray(s),e.vertexAttribPointer(s,2,e.FLOAT,!1,0,0),this.texturePosBuffer=a},H264bsdCanvas.prototype.initTextures=function(){var e=this.contextGL,t=this.shaderProgram,r=this.initTexture(),i=e.getUniformLocation(t,"ySampler");e.uniform1i(i,0),this.yTextureRef=r;var a=this.initTexture(),s=e.getUniformLocation(t,"uSampler");e.uniform1i(s,1),this.uTextureRef=a;var o=this.initTexture(),n=e.getUniformLocation(t,"vSampler");e.uniform1i(n,2),this.vTextureRef=o},H264bsdCanvas.prototype.initTexture=function(){var e=this.contextGL,t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),t},H264bsdCanvas.prototype.drawNextOutputPicture=function(e,t,r,i){var a=this.contextGL;a?this.drawNextOuptutPictureGL(e,t,r,i):this.drawNextOuptutPictureRGBA(e,t,r,i)},H264bsdCanvas.prototype.drawNextOuptutPictureGL=function(e,t,r,i){var a=this.contextGL,s=this.texturePosBuffer,o=this.yTextureRef,n=this.uTextureRef,u=this.vTextureRef;if(null===r)a.viewport(0,0,e,t);else{a.viewport(0,0,r.width,r.height);var h=r.top/t,c=r.left/e,d=r.height/t,m=r.width/e,l=new Float32Array([m,h,c,h,m,d,c,d]);a.bindBuffer(a.ARRAY_BUFFER,s),a.bufferData(a.ARRAY_BUFFER,l,a.DYNAMIC_DRAW)}var p=i,f=e*t,g=p.subarray(0,f);a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,o),a.texImage2D(a.TEXTURE_2D,0,a.LUMINANCE,e,t,0,a.LUMINANCE,a.UNSIGNED_BYTE,g);var y=e/2*t/2,T=p.subarray(f,f+y);a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,n),a.texImage2D(a.TEXTURE_2D,0,a.LUMINANCE,e/2,t/2,0,a.LUMINANCE,a.UNSIGNED_BYTE,T);var v=y,E=p.subarray(f+y,f+y+v);a.activeTexture(a.TEXTURE2),a.bindTexture(a.TEXTURE_2D,u),a.texImage2D(a.TEXTURE_2D,0,a.LUMINANCE,e/2,t/2,0,a.LUMINANCE,a.UNSIGNED_BYTE,E),a.drawArrays(a.TRIANGLE_STRIP,0,4)},H264bsdCanvas.prototype.drawNextOuptutPictureRGBA=function(e,t,r,i){var a=this.canvasElement,r=null,s=i,o=a.getContext("2d"),n=o.getImageData(0,0,e,t);n.data.set(s),null===r?o.putImageData(n,0,0):o.putImageData(n,-r.left,-r.top,0,0,r.width,r.height)},H264bsdCanvas.prototype.clearCanvas=function(){var e=this.contextGL;if(e)e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT);else{var t=this.canvasElement,r=t.getContext("2d");r.clearRect(0,0,t.width,t.height)}},String.prototype.format=function(){var e,t=this;for(e in arguments)t=t.replace(/%[a-z]/,arguments[e]);return t},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}}(),XPlayer.prototype.init=function(e){var t=this;this.status="init",this.display=new H264bsdCanvas(e),this.decoder=new Worker("resource/js/livestream.min.js?20170418");var r=void 0!=this.display.isWebGL();return this.decoder.postMessage({type:"setWebGlMode",data:r}),this.decoder.addEventListener("error",function(e){console.log("Decoder error",e)}),this.decoder.addEventListener("message",function(r){var i=r.data;if(i.hasOwnProperty("type"))switch(i.type){case"pictureParams":croppingParams=i.croppingParams,null===croppingParams?(e.width=i.width,e.height=i.height):(e.width=croppingParams.width,e.height=croppingParams.height),t.listener&&t.listener(102,t.id,"video ready");break;case"noInput":break;case"pictureReady":for(t.listener&&!t.firstFrame&&(t.firstFrame=!0,t.listener(103,t.id,"first frame")),t.width=i.width,t.height=i.height,t.croppingParams=i.croppingParams,t.frames.push(new Uint8Array(i.data));t.frames.length>5;){console.log("Shift frames");var a=t.frames.shift();a=null}break;case"decoderReady":t.ready=!0,t.listener&&t.listener(100,t.id,"Decoder ready");break;case"decoderClosed":t.frames=[],t.display.clearCanvas(),t.listener&&t.listener(105,t.id,"Decoder Closed")}}),this.decoder.playerid},XPlayer.prototype.setSourceUrl=function(e){this.sourceUrl=e;var t=/\/\/([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?$/,r=t.exec(e);r&&r.length>0&&(this.host=r[1],this.port=r[2],this.stream=r[3]),-1!=e.indexOf(".mp4")?this.wsuri="ws://%s:%s/dvr".format(this.host,this.port):this.wsuri="ws://%s:%s/live".format(this.host,this.port)},XPlayer.prototype.setStatusListener=function(e){this.listener=e},XPlayer.prototype.play=function(){if(!this.ready)return void console.log("decoder is not ready");if(this.host&&this.port&&null==this.sock){var e=this;return this.sock=new WebSocket(this.wsuri),this.sock.binaryType="arraybuffer",this.sock.onopen=function(){this.playerid=e.decoder.playerid,e.listener&&e.listener(101,e.id,"socket opened");"%s/%s".format(e.host,e.stream);e.sock.send(JSON.stringify({cmd:"play",stream:e.stream,starttime:e.currentTime})),e.firstFrame=!1,e.status="videoPlaying",requestAnimFrame(function(){e.renderNextFrame(e)})},this.sock.onclose=function(t){console.log(e.id+" connection closed ("+t.code+")"),e.listener&&e.listener(104,e.id,"socket closed")},this.sock.onmessage=function(t){if("string"==typeof t.data){var r=JSON.parse(t.data);"status"==r.type||("duration"==r.type?e.duration=r.duration:"timestamp"==r.type&&(e.currentTime=r.time))}else if(t.data.byteLength>0){var i=new Uint8Array(t.data);(0==i[0]||0==i[1]||0==i[2]||1==i[3])&&e.decoder.postMessage({type:"queueInput",data:i.buffer},[i.buffer])}},!0}return!1},XPlayer.prototype.getCachedLength=function(){return this.frames.length},XPlayer.prototype.getDuration=function(){return this.duration},XPlayer.prototype.getCurrentTime=function(){return this.currentTime},XPlayer.prototype.getRenderCount=function(){var e=this.renderCount;return this.renderCount=0,e},XPlayer.prototype.renderNextFrame=function(e){var t=e;if(t.status="videoPlaying"){if(t.frames.length>0){var r=Date.now(),i=r-t.lastFrameTime;if(i>25||t.frames.length>30){var a=t.frames.shift();t.renderCount++,t.display.drawNextOutputPicture(t.width,t.height,t.croppingParams,a)}}requestAnimFrame(function(){t.renderNextFrame(t)})}},XPlayer.prototype.seek=function(e){this.sock&&(console.log("seek to "+e),this.sock.send(JSON.stringify({cmd:"seek",stream:this.stream,timestamp:e})))},XPlayer.prototype.pause=function(){this.sock&&(console.log("pause stream "+this.stream),this.sock.send(JSON.stringify({cmd:"pause",stream:this.stream})))},XPlayer.prototype.resume=function(){this.sock&&(console.log("resume stream "+this.stream),this.sock.send(JSON.stringify({cmd:"resume",stream:this.stream})))},XPlayer.prototype.stop=function(){if(this.status="videoStop",this.sock){if(1==this.sock.readyState){var e="%s/%s".format(this.host,this.stream);console.log("stop stream "+e),this.sock.send(JSON.stringify({cmd:"stop",stream:e}))}this.sock.close(),this.sock=null,this.decoder.postMessage({type:"close"})}};